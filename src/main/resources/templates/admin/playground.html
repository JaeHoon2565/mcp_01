<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout :: layout(~{::body})}">
<body>
<div>
    <h1>ğŸ§ª ëª¨ë¸ ì‹¤í—˜</h1>

    <!-- ğŸ”¹ ì œê³µì ì„ íƒ -->
    <div class="mb-3">
        <label class="form-label">ì œê³µì:</label>
        <select id="providerSelect" class="form-select" required onchange="onProviderChange()">
            <option value="" disabled selected>-- ì œê³µìë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
            <option th:each="entry : ${groupedModels}"
                    th:value="${entry.key}"
                    th:text="${entry.key}"></option>
        </select>
    </div>

    <!-- ğŸ”¹ ëª¨ë¸ ì„ íƒ (ì œê³µìì— ë”°ë¼ ë™ì  ë³€ê²½ë¨) -->
    <div class="mb-3">
        <label class="form-label">ëª¨ë¸ëª…:</label>
        <select id="modelSelect" class="form-select" required>
            <option value="" disabled selected>-- ë¨¼ì € ì œê³µìë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
        </select>
    </div>

    <!-- ğŸ”¹ ì»¨í…ìŠ¤íŠ¸ ì„¸íŠ¸ ì„ íƒ -->
    <div class="mb-3">
        <label class="form-label">ì»¨í…ìŠ¤íŠ¸ ì„¸íŠ¸:</label>
        <select id="contextSelect" class="form-select" required>
            <option value="" disabled selected>-- ì—­í• /ìƒí™©ì„ ì„ íƒí•˜ì„¸ìš” --</option>
            <option th:each="set : ${contextSets}"
                    th:value="${set.id}"
                    th:text="${set.name} + ' | ' + ${set.role} + ' | ' + ${set.tone}"></option>
        </select>
    </div>

    <!-- ğŸ”¹ ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥ -->
    <div class="mb-3">
        <label class="form-label">í”„ë¡¬í”„íŠ¸:</label>
        <textarea class="form-control" id="query" rows="5"
                  placeholder="ì˜ˆ: DB ì„¤ê³„ì— ì–´ë–¤ ì»¬ëŸ¼ì´ í•„ìš”í• ê¹Œ?" required></textarea>
    </div>

    <button class="btn btn-primary" onclick="sendRequest()">ì‹¤í–‰</button>

    <!-- ğŸ”¹ ê²°ê³¼ ì˜ì—­ -->
    <div id="resultBox" class="mt-4" style="display:none">
        <h3> ê²°ê³¼</h3>
        <pre id="resultText" class="bg-light p-3 border rounded"></pre>
    </div>

    <!-- ğŸ”¹ ì—ëŸ¬ ì˜ì—­ -->
    <div id="errorBox" class="alert alert-danger mt-3" style="display:none"></div>
</div>

<!-- âœ… ëª¨ë¸ ì „ì²´ ë¦¬ìŠ¤íŠ¸ (ìë°”ìŠ¤í¬ë¦½íŠ¸ìš©) -->
<script th:inline="javascript">
    const modelMap = /*[[${groupedModels}]]*/ {};
</script>

<!-- âœ… ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ -->
<script>
    function onProviderChange() {
        const provider = document.getElementById('providerSelect').value;
        const modelSelect = document.getElementById('modelSelect');

        // ì´ˆê¸°í™”
        modelSelect.innerHTML = '<option disabled selected>-- ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš” --</option>';

        const models = modelMap[provider];
        if (models) {
            models.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m.name;
                opt.text = m.name;
                modelSelect.appendChild(opt);
            });
        }
    }

    async function sendRequest() {
        const provider = document.getElementById('providerSelect').value;
        const model = document.getElementById('modelSelect').value;
        const contextSetId = document.getElementById('contextSelect').value;
        const query = document.getElementById('query').value;

        const payload = {
            project: "playground",
            provider: provider,
            model: model,
            query: query,
            contextSetId: contextSetId
        };

        try {
            const res = await fetch('/infer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");

            const data = await res.json();
            document.getElementById('resultBox').style.display = 'block';
            document.getElementById('resultText').innerText = data.result;
            document.getElementById('errorBox').style.display = 'none';

        } catch (e) {
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerText = 'âŒ ì˜¤ë¥˜: ' + e.message;
            document.getElementById('resultBox').style.display = 'none';
        }
    }
</script>
</body>
</html>
